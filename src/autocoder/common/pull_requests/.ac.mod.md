
# Pull Requests æ¨¡å—

ç»Ÿä¸€çš„ Pull Request åˆ›å»ºå’Œç®¡ç†æ¨¡å—ï¼Œæ”¯æŒ GitHubã€GitLabã€Giteeã€GitCode å››å¤§ä»£ç æ‰˜ç®¡å¹³å°çš„ PR æ“ä½œã€‚

## ç›®å½•ç»“æ„

```
src/autocoder/common/pull_requests/
â”œâ”€â”€ __init__.py                    # æ¨¡å—å…¥å£ï¼Œå¯¼å‡ºä¸»è¦æ¥å£
â”œâ”€â”€ models.py                      # æ•°æ®æ¨¡å‹å®šä¹‰ï¼ˆPRConfig, PRResultç­‰ï¼‰
â”œâ”€â”€ base_provider.py               # åŸºç¡€æä¾›è€…æŠ½è±¡ç±»
â”œâ”€â”€ providers/                     # å„å¹³å°å…·ä½“å®ç°
â”‚   â”œâ”€â”€ __init__.py               # æä¾›è€…æ¨¡å—å…¥å£
â”‚   â”œâ”€â”€ github_provider.py        # GitHub API å®ç°
â”‚   â”œâ”€â”€ gitlab_provider.py        # GitLab API å®ç°  
â”‚   â”œâ”€â”€ gitee_provider.py         # Gitee API å®ç°
â”‚   â””â”€â”€ gitcode_provider.py       # GitCode API å®ç°
â”œâ”€â”€ config.py                      # é…ç½®ç®¡ç†å’Œè®¤è¯å¤„ç†
â”œâ”€â”€ manager.py                     # ä¸»ç®¡ç†å™¨ï¼Œç»Ÿä¸€å„å¹³å°æ“ä½œ
â”œâ”€â”€ utils.py                       # å·¥å…·å‡½æ•°ï¼ˆURLè§£æã€Gitæ“ä½œç­‰ï¼‰
â””â”€â”€ .ac.mod.md                     # æœ¬æ–‡æ¡£
```

## å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ä½¿ç”¨æ–¹å¼

```python
# å¯¼å…¥å¿…è¦çš„æ¨¡å—
from autocoder.common.pull_requests import create_pull_request, PullRequestManager, PRConfig

# 1. ç®€å•æ–¹å¼ï¼šç›´æ¥åˆ›å»º PR
result = create_pull_request(
    repo_path="/path/to/your/repo",
    source_branch="feature/new-feature",
    target_branch="main",
    title="æ·»åŠ æ–°åŠŸèƒ½",
    description="è¿™æ˜¯ä¸€ä¸ªæ–°åŠŸèƒ½çš„å®ç°",
    platform="github",  # æ”¯æŒ: github, gitlab, gitee, gitcode
    token="your_access_token"
)

if result.success:
    print(f"PR åˆ›å»ºæˆåŠŸ: {result.pr_url}")
    print(f"PR ç¼–å·: {result.pr_number}")
else:
    print(f"åˆ›å»ºå¤±è´¥: {result.error_message}")

# 2. ä½¿ç”¨é…ç½®ç®¡ç†å™¨
config = PRConfig(
    platform="github",
    token="your_access_token",
    base_url="https://api.github.com",  # å¯é€‰ï¼Œä½¿ç”¨é»˜è®¤å€¼
    timeout=30
)

manager = PullRequestManager(config)
result = manager.create_pull_request(
    repo_path="/path/to/repo",
    source_branch="feature/fix-bug", 
    target_branch="develop",
    title="ä¿®å¤é‡è¦Bug",
    description="ä¿®å¤äº†å¯¼è‡´åº”ç”¨å´©æºƒçš„å…³é”®é—®é¢˜"
)

# 3. è‡ªåŠ¨æ£€æµ‹å¹³å°
# æ ¹æ® Git remote URL è‡ªåŠ¨è¯†åˆ«å¹³å°
result = create_pull_request(
    repo_path="/path/to/repo",
    source_branch="hotfix/urgent-fix",
    target_branch="main",
    title="ç´§æ€¥ä¿®å¤",
    description="ä¿®å¤ç”Ÿäº§ç¯å¢ƒé—®é¢˜",
    # platform å‚æ•°å¯çœç•¥ï¼Œå°†è‡ªåŠ¨æ£€æµ‹
    token="your_access_token"
)
```

### é…ç½®ç®¡ç†

```python
# é…ç½®æ–‡ä»¶æ–¹å¼
config_data = {
    "github": {
        "token": "ghp_xxxxxxxxxxxx",
        "base_url": "https://api.github.com"
    },
    "gitlab": {
        "token": "glpat-xxxxxxxxxxxx", 
        "base_url": "https://gitlab.com/api/v4"
    },
    "gitee": {
        "token": "xxxxxxxxxxxxxx",
        "base_url": "https://gitee.com/api/v5"
    },
    "gitcode": {
        "token": "xxxxxxxxxxxxxx",
        "base_url": "https://gitcode.net/api/v4"
    }
}

# ä»é…ç½®å­—å…¸åˆ›å»º
config = PRConfig.from_dict("github", config_data["github"])

# ä»ç¯å¢ƒå˜é‡åˆ›å»º
config = PRConfig.from_env("github")  # è¯»å– GITHUB_TOKEN ç­‰ç¯å¢ƒå˜é‡

# ä»é…ç½®æ–‡ä»¶åˆ›å»º
config = PRConfig.from_file("github", "~/.autocoder/pr_config.json")
```

## æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. PullRequestManager ä¸»ç®¡ç†å™¨

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- **ç»Ÿä¸€æ¥å£**ï¼šä¸ºæ‰€æœ‰å¹³å°æä¾›ç»Ÿä¸€çš„ PR æ“ä½œæ¥å£
- **è‡ªåŠ¨æ£€æµ‹**ï¼šæ ¹æ® Git remote URL è‡ªåŠ¨è¯†åˆ«å¹³å°ç±»å‹
- **é…ç½®ç®¡ç†**ï¼šé›†ä¸­ç®¡ç†å„å¹³å°çš„è®¤è¯å’Œé…ç½®ä¿¡æ¯
- **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

**ä¸»è¦æ–¹æ³•ï¼š**
- `create_pull_request()`: åˆ›å»º Pull Request
- `get_pull_request()`: è·å– PR è¯¦ç»†ä¿¡æ¯
- `update_pull_request()`: æ›´æ–° PR æ ‡é¢˜å’Œæè¿°
- `close_pull_request()`: å…³é—­ PR
- `merge_pull_request()`: åˆå¹¶ PR

### 2. å¹³å°æä¾›è€…æ¶æ„

**åŸºç±»è®¾è®¡ï¼š**
```python
class BasePlatformProvider:
    """å¹³å°æä¾›è€…åŸºç±»ï¼Œå®šä¹‰ç»Ÿä¸€æ¥å£"""
    
    def create_pr(self, repo_info: RepoInfo, pr_data: PRData) -> PRResult:
        """åˆ›å»º Pull Request"""
        raise NotImplementedError
    
    def get_pr(self, repo_info: RepoInfo, pr_number: int) -> PRResult:
        """è·å– PR ä¿¡æ¯"""
        raise NotImplementedError
    
    def update_pr(self, repo_info: RepoInfo, pr_number: int, **kwargs) -> PRResult:
        """æ›´æ–° PR"""
        raise NotImplementedError
```

**å¹³å°ç‰¹æ€§ï¼š**
- **GitHub**: æ”¯æŒ GitHub.com å’Œ GitHub Enterprise
- **GitLab**: æ”¯æŒ GitLab.com å’Œç§æœ‰éƒ¨ç½²
- **Gitee**: æ”¯æŒ Gitee.com çš„ API v5
- **GitCode**: æ”¯æŒ GitCode.net çš„ API

## Mermaid æ¨¡å—ä¾èµ–å›¾

```mermaid
graph TB
    %% æ ¸å¿ƒæ¥å£å±‚
    API[å…¬å…± API<br/>create_pull_request()<br/>PullRequestManager]
    
    %% ç®¡ç†å±‚
    Manager[PullRequestManager<br/>ç»Ÿä¸€ç®¡ç†å™¨]
    Config[PRConfig<br/>é…ç½®ç®¡ç†]
    Utils[Utils<br/>å·¥å…·å‡½æ•°]
    
    %% æä¾›è€…å±‚
    BaseProvider[BasePlatformProvider<br/>åŸºç¡€æä¾›è€…æŠ½è±¡ç±»]
    GitHubProvider[GitHubProvider<br/>GitHub å®ç°]
    GitLabProvider[GitLabProvider<br/>GitLab å®ç°]
    GiteeProvider[GiteeProvider<br/>Gitee å®ç°]
    GitCodeProvider[GitCodeProvider<br/>GitCode å®ç°]
    
    %% æ•°æ®æ¨¡å‹å±‚
    Models[æ•°æ®æ¨¡å‹<br/>PRConfig, PRResult<br/>RepoInfo, PRData]
    
    %% å¤–éƒ¨ä¾èµ–
    GitUtils[git_utils.py<br/>Git æ“ä½œ]
    Requests[requests<br/>HTTP å®¢æˆ·ç«¯]
    Pydantic[pydantic<br/>æ•°æ®éªŒè¯]
    
    %% ä¾èµ–å…³ç³»
    API --> Manager
    Manager --> Config
    Manager --> BaseProvider
    Manager --> Utils
    Manager --> Models
    
    BaseProvider --> GitHubProvider
    BaseProvider --> GitLabProvider
    BaseProvider --> GiteeProvider
    BaseProvider --> GitCodeProvider
    
    GitHubProvider --> Requests
    GitLabProvider --> Requests
    GiteeProvider --> Requests
    GitCodeProvider --> Requests
    
    Manager --> GitUtils
    Utils --> GitUtils
    Models --> Pydantic
    
    %% æ ·å¼å®šä¹‰
    classDef coreClass fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef providerClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef modelClass fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef externalClass fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    
    class API,Manager,Config,Utils coreClass
    class BaseProvider,GitHubProvider,GitLabProvider,GiteeProvider,GitCodeProvider providerClass
    class Models modelClass
    class GitUtils,Requests,Pydantic externalClass
```

### ä¾èµ–å…³ç³»è¯´æ˜

**å†…éƒ¨æ¨¡å—ä¾èµ–ï¼š**
- `manager.py` ä¾èµ–æ‰€æœ‰æä¾›è€…å®ç°
- å„æä¾›è€…ç»§æ‰¿è‡ª `base_provider.py`
- `config.py` ä¸ºç‹¬ç«‹çš„é…ç½®ç®¡ç†æ¨¡å—
- `utils.py` æä¾›é€šç”¨å·¥å…·å‡½æ•°

**å¤–éƒ¨ä¾èµ–å…³ç³»ï¼š**
- **git_utils.py**: å¤ç”¨ç°æœ‰çš„ Git æ“ä½œåŠŸèƒ½
- **requests**: ç”¨äº HTTP API è°ƒç”¨
- **pydantic**: ç”¨äºæ•°æ®æ¨¡å‹éªŒè¯
- **loguru**: ç”¨äºæ—¥å¿—è®°å½•ï¼ˆé¡¹ç›®æ ‡å‡†ï¼‰

**æ•°æ®æµå‘ï¼š**
1. ç”¨æˆ·è°ƒç”¨å…¬å…± API
2. Manager æ ¹æ®å¹³å°é€‰æ‹©å¯¹åº”çš„ Provider
3. Provider è°ƒç”¨å¹³å° API åˆ›å»º PR
4. ç»“æœé€šè¿‡ç»Ÿä¸€çš„æ•°æ®æ¨¡å‹è¿”å›

## ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### 1. è‡ªåŠ¨åŒ–ä»£ç å®¡æŸ¥æµç¨‹

```python
def create_review_pr(repo_path: str, feature_branch: str):
    """åˆ›å»ºä»£ç å®¡æŸ¥ PR"""
    
    # è‡ªåŠ¨æ£€æµ‹å¹³å°å¹¶åˆ›å»º PR
    result = create_pull_request(
        repo_path=repo_path,
        source_branch=feature_branch,
        target_branch="develop",
        title=f"Code Review: {feature_branch}",
        description="""
## å˜æ›´è¯´æ˜
- æ–°åŠŸèƒ½å®ç°
- å•å…ƒæµ‹è¯•è¦†ç›–
- æ–‡æ¡£æ›´æ–°

## æ£€æŸ¥æ¸…å•
- [ ] ä»£ç é£æ ¼ç¬¦åˆè§„èŒƒ
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] æ–‡æ¡£å·²æ›´æ–°
- [ ] æ€§èƒ½å½±å“è¯„ä¼°
        """,
        token=os.getenv("GIT_TOKEN")
    )
    
    if result.success:
        print(f"âœ… PR åˆ›å»ºæˆåŠŸ: {result.pr_url}")
        return result.pr_number
    else:
        print(f"âŒ åˆ›å»ºå¤±è´¥: {result.error_message}")
        return None
```

### 2. å¤šå¹³å°åŒæ­¥å‘å¸ƒ

```python
def sync_release_to_mirrors(main_repo: str, mirror_repos: List[str], tag: str):
    """å°†å‘å¸ƒåŒæ­¥åˆ°å¤šä¸ªé•œåƒä»“åº“"""
    
    results = []
    
    for mirror_repo in mirror_repos:
        result = create_pull_request(
            repo_path=mirror_repo,
            source_branch=f"release/{tag}",
            target_branch="main",
            title=f"Release {tag}",
            description=f"åŒæ­¥å‘å¸ƒç‰ˆæœ¬ {tag} åˆ°é•œåƒä»“åº“",
            # è‡ªåŠ¨æ£€æµ‹å„é•œåƒä»“åº“çš„å¹³å°ç±»å‹
        )
        results.append(result)
    
    return results
```

### 3. ç´§æ€¥ä¿®å¤å·¥ä½œæµ

```python
def create_hotfix_pr(repo_path: str, hotfix_branch: str, issue_number: str):
    """åˆ›å»ºç´§æ€¥ä¿®å¤ PR"""
    
    # è·å–é—®é¢˜æè¿°
    issue_desc = f"ä¿®å¤å…³é”®é—®é¢˜ #{issue_number}"
    
    result = create_pull_request(
        repo_path=repo_path,
        source_branch=hotfix_branch,
        target_branch="main",
        title=f"ğŸš¨ Hotfix: {issue_desc}",
        description=f"""
## ç´§æ€¥ä¿®å¤

**ç›¸å…³é—®é¢˜**: #{issue_number}

### ä¿®å¤å†…å®¹
- è¯†åˆ«å¹¶ä¿®å¤æ ¹æœ¬åŸå› 
- æ·»åŠ å›å½’æµ‹è¯•
- éªŒè¯ä¿®å¤æ•ˆæœ

### å½±å“èŒƒå›´
- ä»…å½±å“é—®é¢˜ç›¸å…³åŠŸèƒ½
- æ— ç ´åæ€§å˜æ›´

**ä¼˜å…ˆçº§**: ğŸ”´ é«˜ä¼˜å…ˆçº§
**éœ€è¦ç«‹å³å®¡æŸ¥å’Œåˆå¹¶**
        """,
        labels=["hotfix", "priority:high"],  # æŸäº›å¹³å°æ”¯æŒæ ‡ç­¾
        assignees=["team-lead"],  # è‡ªåŠ¨åˆ†é…å®¡æŸ¥è€…
    )
    
    return result
```

### 4. é…ç½®ä¸åŒç¯å¢ƒ

```python
# å¼€å‘ç¯å¢ƒé…ç½®
dev_config = PRConfig(
    platform="gitlab",
    base_url="https://gitlab.internal.company.com/api/v4",
    token=os.getenv("GITLAB_INTERNAL_TOKEN"),
    timeout=60
)

# ç”Ÿäº§ç¯å¢ƒé…ç½®  
prod_config = PRConfig(
    platform="github",
    token=os.getenv("GITHUB_PROD_TOKEN"),
    verify_ssl=True,
    retry_count=3
)

# æ ¹æ®ç¯å¢ƒé€‰æ‹©é…ç½®
env = os.getenv("ENVIRONMENT", "dev")
config = dev_config if env == "dev" else prod_config

manager = PullRequestManager(config)
```

## é«˜çº§ç‰¹æ€§

### 1. è‡ªåŠ¨å¹³å°æ£€æµ‹

```python
# æ”¯æŒçš„ Git remote URL æ ¼å¼è‡ªåŠ¨æ£€æµ‹ï¼š

# GitHub
# - https://github.com/user/repo.git
# - git@github.com:user/repo.git

# GitLab  
# - https://gitlab.com/user/repo.git
# - git@gitlab.com:user/repo.git

# Gitee
# - https://gitee.com/user/repo.git
# - git@gitee.com:user/repo.git

# GitCode
# - https://gitcode.net/user/repo.git
# - git@gitcode.net:user/repo.git

def detect_platform_from_repo(repo_path: str) -> str:
    """ä»ä»“åº“ remote URL æ£€æµ‹å¹³å°ç±»å‹"""
    # å®ç°è‡ªåŠ¨æ£€æµ‹é€»è¾‘
    pass
```

### 2. æ‰¹é‡æ“ä½œæ”¯æŒ

```python
def create_multiple_prs(pr_configs: List[dict]) -> List[PRResult]:
    """æ‰¹é‡åˆ›å»º PR"""
    
    results = []
    for config in pr_configs:
        result = create_pull_request(**config)
        results.append(result)
    
    return results

# ä½¿ç”¨ç¤ºä¾‹
pr_configs = [
    {
        "repo_path": "/path/to/repo1",
        "source_branch": "feature-1",
        "target_branch": "main",
        "title": "åŠŸèƒ½1å®ç°"
    },
    {
        "repo_path": "/path/to/repo2", 
        "source_branch": "feature-2",
        "target_branch": "develop",
        "title": "åŠŸèƒ½2å®ç°"
    }
]

results = create_multiple_prs(pr_configs)
```

### 3. æ¨¡æ¿æ”¯æŒ

```python
# PR æ¨¡æ¿é…ç½®
template_config = {
    "bug_fix": {
        "title_prefix": "ğŸ› Bug Fix:",
        "description_template": """
## é—®é¢˜æè¿°
{problem_description}

## è§£å†³æ–¹æ¡ˆ
{solution_description}

## æµ‹è¯•
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ‰‹åŠ¨æµ‹è¯•éªŒè¯

## å½±å“èŒƒå›´
{impact_scope}
        """
    },
    "feature": {
        "title_prefix": "âœ¨ Feature:",
        "description_template": """
## æ–°åŠŸèƒ½è¯´æ˜
{feature_description}

## å®ç°ç»†èŠ‚
{implementation_details}

## ä½¿ç”¨ç¤ºä¾‹
{usage_examples}
        """
    }
}

# ä½¿ç”¨æ¨¡æ¿åˆ›å»º PR
result = create_pull_request(
    repo_path="/path/to/repo",
    source_branch="fix/login-issue",
    target_branch="main",
    template_type="bug_fix",
    template_vars={
        "problem_description": "ç”¨æˆ·ç™»å½•æ—¶å‡ºç°è¶…æ—¶é”™è¯¯",
        "solution_description": "ä¼˜åŒ–è®¤è¯æµç¨‹ï¼Œå¢åŠ é‡è¯•æœºåˆ¶",
        "impact_scope": "ä»…å½±å“ç™»å½•åŠŸèƒ½ï¼Œæ— ç ´åæ€§å˜æ›´"
    }
)
```

## é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

### å¼‚å¸¸ç±»å‹

```python
from autocoder.common.pull_requests.exceptions import (
    PRError,                    # åŸºç¡€å¼‚å¸¸
    AuthenticationError,        # è®¤è¯å¤±è´¥
    RepositoryNotFoundError,    # ä»“åº“ä¸å­˜åœ¨
    BranchNotFoundError,        # åˆ†æ”¯ä¸å­˜åœ¨
    NetworkError,               # ç½‘ç»œé”™è¯¯
    RateLimitError,            # API é™æµ
    ValidationError            # å‚æ•°éªŒè¯é”™è¯¯
)
```

### é”™è¯¯å¤„ç†ç¤ºä¾‹

```python
try:
    result = create_pull_request(
        repo_path="/path/to/repo",
        source_branch="feature/new",
        target_branch="main",
        title="æ–°åŠŸèƒ½",
        token="invalid_token"
    )
except AuthenticationError as e:
    print(f"è®¤è¯å¤±è´¥: {e}")
    print("è¯·æ£€æŸ¥ token æ˜¯å¦æ­£ç¡®ä¸”æœ‰è¶³å¤Ÿæƒé™")
except BranchNotFoundError as e:
    print(f"åˆ†æ”¯ä¸å­˜åœ¨: {e}")
    print("è¯·ç¡®ä¿æºåˆ†æ”¯å’Œç›®æ ‡åˆ†æ”¯éƒ½å­˜åœ¨")
except RateLimitError as e:
    print(f"API é™æµ: {e}")
    print(f"è¯·ç­‰å¾… {e.retry_after} ç§’åé‡è¯•")
except PRError as e:
    print(f"åˆ›å»º PR å¤±è´¥: {e}")
```

## é…ç½®é€‰é¡¹è¯¦è§£

### PRConfig å®Œæ•´é…ç½®

```python
config = PRConfig(
    # åŸºç¡€é…ç½®
    platform="github",                    # å¹³å°ç±»å‹
    token="your_access_token",            # è®¿é—®ä»¤ç‰Œ
    base_url="https://api.github.com",    # API åŸºç¡€URL
    
    # ç½‘ç»œé…ç½®
    timeout=30,                           # è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    verify_ssl=True,                      # SSLè¯ä¹¦éªŒè¯
    proxy=None,                           # ä»£ç†é…ç½®
    
    # é‡è¯•é…ç½®
    retry_count=3,                        # é‡è¯•æ¬¡æ•°
    retry_delay=1,                        # é‡è¯•å»¶è¿Ÿï¼ˆç§’ï¼‰
    backoff_factor=2,                     # é€€é¿å› å­
    
    # å…¶ä»–é€‰é¡¹
    user_agent="AutoCoder-PR/1.0",        # User-Agent
    default_labels=[],                    # é»˜è®¤æ ‡ç­¾
    default_assignees=[],                 # é»˜è®¤å®¡æŸ¥è€…
)
```

### å¹³å°ç‰¹å®šé…ç½®

```python
# GitHub é…ç½®
github_config = PRConfig(
    platform="github",
    token="ghp_xxxxxxxxxxxx",
    # GitHub Enterprise æ”¯æŒ
    base_url="https://github.enterprise.com/api/v3",
    # GitHub ç‰¹å®šé€‰é¡¹
    draft=False,                          # æ˜¯å¦åˆ›å»ºè‰ç¨¿ PR
    maintainer_can_modify=True,           # ç»´æŠ¤è€…å¯ä¿®æ”¹
)

# GitLab é…ç½®  
gitlab_config = PRConfig(
    platform="gitlab",
    token="glpat-xxxxxxxxxxxx",
    # GitLab ç‰¹å®šé€‰é¡¹
    remove_source_branch=True,            # åˆå¹¶ååˆ é™¤æºåˆ†æ”¯
    squash=False,                         # æ˜¯å¦å‹ç¼©æäº¤
)

# Gitee é…ç½®
gitee_config = PRConfig(
    platform="gitee", 
    token="xxxxxxxxxxxxxx",
    # Gitee ç‰¹å®šé€‰é¡¹
    prune_source_branch=True,             # åˆå¹¶ååˆ é™¤æºåˆ†æ”¯
)
```

## æœ€ä½³å®è·µ

### 1. å®‰å…¨çš„ Token ç®¡ç†

```python
# æ¨èï¼šä½¿ç”¨ç¯å¢ƒå˜é‡
config = PRConfig.from_env("github")  # è¯»å– GITHUB_TOKEN

# æ¨èï¼šä½¿ç”¨é…ç½®æ–‡ä»¶
config = PRConfig.from_file("github", "~/.autocoder/tokens.json")

# ä¸æ¨èï¼šç¡¬ç¼–ç  token
# config = PRConfig(platform="github", token="ghp_hardcoded")
```

### 2. é”™è¯¯é‡è¯•ç­–ç•¥

```python
def create_pr_with_retry(max_attempts=3, **kwargs):
    """å¸¦é‡è¯•çš„ PR åˆ›å»º"""
    
    for attempt in range(max_attempts):
        try:
            return create_pull_request(**kwargs)
        except RateLimitError as e:
            if attempt < max_attempts - 1:
                time.sleep(e.retry_after)
                continue
            raise
        except NetworkError as e:
            if attempt < max_attempts - 1:
                time.sleep(2 ** attempt)  # æŒ‡æ•°é€€é¿
                continue
            raise
```

### 3. åˆ†æ”¯ç®¡ç†é›†æˆ

```python
from autocoder.common.git_utils import get_current_branch, commit_changes

def feature_to_pr_workflow(repo_path: str, feature_name: str):
    """åŠŸèƒ½å¼€å‘åˆ° PR çš„å®Œæ•´å·¥ä½œæµ"""
    
    # 1. ç¡®ä¿å½“å‰åˆ†æ”¯æ˜¯åŠŸèƒ½åˆ†æ”¯
    current_branch = get_current_branch(repo_path)
    if not current_branch.startswith(f"feature/{feature_name}"):
        raise ValueError("è¯·åœ¨æ­£ç¡®çš„åŠŸèƒ½åˆ†æ”¯ä¸Šæ“ä½œ")
    
    # 2. æäº¤å½“å‰å˜æ›´
    commit_result = commit_changes(repo_path, f"å®Œæˆ {feature_name} åŠŸèƒ½å¼€å‘")
    if not commit_result.success:
        raise RuntimeError(f"æäº¤å¤±è´¥: {commit_result.error_message}")
    
    # 3. åˆ›å»º PR
    pr_result = create_pull_request(
        repo_path=repo_path,
        source_branch=current_branch,
        target_branch="develop",
        title=f"Feature: {feature_name}",
        description=f"å®ç° {feature_name} åŠŸèƒ½"
    )
    
    return pr_result
```

### 4. å›¢é˜Ÿåä½œè§„èŒƒ

```python
# å›¢é˜Ÿ PR åˆ›å»ºè§„èŒƒ
TEAM_PR_DEFAULTS = {
    "target_branch": "develop",           # ç»Ÿä¸€ç›®æ ‡åˆ†æ”¯
    "labels": ["needs-review"],           # é»˜è®¤æ ‡ç­¾
    "assignees": ["team-lead"],           # é»˜è®¤å®¡æŸ¥è€…
    "description_template": """
## å˜æ›´è¯´æ˜
{description}

## æµ‹è¯•
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] ä»£ç é£æ ¼æ£€æŸ¥é€šè¿‡
- [ ] åŠŸèƒ½æµ‹è¯•éªŒè¯

## ç›¸å…³æ–‡æ¡£
- [ ] API æ–‡æ¡£å·²æ›´æ–°
- [ ] ç”¨æˆ·æ–‡æ¡£å·²æ›´æ–°

/cc @team-lead @senior-dev
    """
}

def create_team_pr(repo_path: str, source_branch: str, title: str, description: str):
    """æŒ‰å›¢é˜Ÿè§„èŒƒåˆ›å»º PR"""
    
    formatted_description = TEAM_PR_DEFAULTS["description_template"].format(
        description=description
    )
    
    return create_pull_request(
        repo_path=repo_path,
        source_branch=source_branch,
        target_branch=TEAM_PR_DEFAULTS["target_branch"],
        title=title,
        description=formatted_description,
        labels=TEAM_PR_DEFAULTS["labels"],
        assignees=TEAM_PR_DEFAULTS["assignees"]
    )
```

## å¸¸è§é—®é¢˜è§£ç­”

### Q: å¦‚ä½•å¤„ç†ä¸åŒå¹³å°çš„ API å·®å¼‚ï¼Ÿ

A: æ¨¡å—é€šè¿‡ç»Ÿä¸€çš„æŠ½è±¡å±‚å¤„ç†å¹³å°å·®å¼‚ï¼š
```python
# æ‰€æœ‰å¹³å°éƒ½æ”¯æŒçš„æ ¸å¿ƒåŠŸèƒ½
result = create_pull_request(...)  # ç»Ÿä¸€æ¥å£

# å¹³å°ç‰¹å®šåŠŸèƒ½é€šè¿‡é…ç½®å¯ç”¨
config = PRConfig(
    platform="github",
    draft=True  # GitHub ç‰¹æœ‰çš„è‰ç¨¿ PR
)
```

### Q: å¦‚ä½•é…ç½®ä¼ä¸šå†…éƒ¨éƒ¨ç½²çš„å¹³å°ï¼Ÿ

A: é€šè¿‡ base_url å‚æ•°æŒ‡å®šå†…éƒ¨ API åœ°å€ï¼š
```python
config = PRConfig(
    platform="gitlab",
    base_url="https://gitlab.internal.company.com/api/v4",
    token="your_internal_token",
    verify_ssl=False  # å¦‚æœä½¿ç”¨è‡ªç­¾åè¯ä¹¦
)
```

### Q: å¦‚ä½•å¤„ç† API é™æµï¼Ÿ

A: æ¨¡å—å†…ç½®äº†é™æµå¤„ç†æœºåˆ¶ï¼š
```python
# è‡ªåŠ¨é‡è¯•å’Œé€€é¿
config = PRConfig(
    platform="github",
    retry_count=5,
    retry_delay=2,
    backoff_factor=2
)

# æ•è·é™æµå¼‚å¸¸
try:
    result = create_pull_request(...)
except RateLimitError as e:
    print(f"è¯·ç­‰å¾… {e.retry_after} ç§’")
```

### Q: æ”¯æŒå“ªäº›è®¤è¯æ–¹å¼ï¼Ÿ

A: æ”¯æŒå„å¹³å°çš„ä¸»è¦è®¤è¯æ–¹å¼ï¼š

- **GitHub**: Personal Access Token (PAT), GitHub App Token
- **GitLab**: Personal Access Token, Project Access Token
- **Gitee**: Personal Access Token
- **GitCode**: Personal Access Token

### Q: å¦‚ä½•è‡ªåŠ¨æ£€æµ‹ä»“åº“å¹³å°ï¼Ÿ

A: åŸºäº Git remote URL è‡ªåŠ¨æ£€æµ‹ï¼š
```python
# æ— éœ€æŒ‡å®š platformï¼Œè‡ªåŠ¨æ£€æµ‹
result = create_pull_request(
    repo_path="/path/to/repo",  # åŒ…å« .git çš„ä»“åº“è·¯å¾„
    source_branch="feature",
    target_branch="main",
    title="è‡ªåŠ¨æ£€æµ‹å¹³å°",
    # platform å‚æ•°å¯çœç•¥
)
```

---

*æœ¬æ¨¡å—ä¸º AutoCoder é¡¹ç›®çš„ Pull Request ç®¡ç†åŠŸèƒ½æä¾›ç»Ÿä¸€ã€ç®€æ´çš„æ¥å£ï¼Œæ”¯æŒä¸»æµä»£ç æ‰˜ç®¡å¹³å°çš„ PR æ“ä½œã€‚*

